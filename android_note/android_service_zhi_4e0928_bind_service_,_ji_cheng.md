# Android Service 之三(Bind Service, 继承自 Binder 类)


<div id="blog_content" class="blog_content">
    <p>&nbsp;之前提及过，启动Service有两种方式：startService 与 bindService。前者已经说过如何使用，所以，这篇贴子主要是关于 bind service的。 这里所讨论的是仅针对那些被绑定的service的，而那些既被startService() 又被 bindService() 的 service 不在此范围内。</p>
<p>① Bind Service就像是C/S架构中的服务端，其他组件（比如 Activity）绑定到它（通过 bindService()），可以向它发送请求，可以接受从它返回的响应，它甚至还提供了进程间通信（IPC）功能。</p>
<p>② 一个service要想能够被其他组件绑定，那么它的 onBind() 方法必须被实现，且必须返回一个 IBinder 对象，然后其他组件可以通过这个 IBinder 对象与该 service 进行通讯。</p>
<p>③ 多个client可以绑定至同一个service，但该 service 的onBind() 方法只会在第一个 client 绑定至其的时候被调用，当其他 client 再次绑定到它的时候，并不会调用&nbsp; onBind() 方法，而是直接返回第一次被调用时产生的那个 IBinder 对象。也就是说，在其生命周期内，onBind() 只会被调用一次。</p>
<p>④ Bind Service 的生命周期如下图所示:</p>
<p><br><img alt="" src="images/cdfa048a-d545-31c5-b250-2ec546863eb3.jpg"><br>&nbsp;</p>
<p>⑤ Bind Service 不会在后台无限期的一直运行，而是当所有绑定至其的组件都调用了 unbindService() 进行解绑之后，系统就会将其停掉以回收资源。</p>
<p>&nbsp;</p>
<p>⑥ 当我们要实现一个 Bind Service 的时候，最重要的就是实现它的 onBind() 方法以返回一个 IBinder 对象</p>
<p>&nbsp;</p>
<p>要生成一个 Bound Service ，共有三种方式：继承自 Binder 类，使用 Messenger ，使用 AIDL。下面且听小生一一道来。</p>
<p><strong><span style="color: #ff0000;">第一种：继承自 Binder 类</span></strong></p>
<p>需要注意的是，这种方式仅仅适用于这种场合：service 与 application 在同一个进程中。这种场合也是最最常见的。</p>
<p>它分以下几个步骤：</p>
<p>a. 在你的 service 类中声明一个内部类来继承 Binder 类。在该内部类中，最好提供一个公共方法来返回你的 service 实例。</p>
<p>b. 在你的 service 类中需要声明一个这个内部类的实例，以供在 onBind() 方法中返回</p>
<p>c.&nbsp;在 client 端，在 onServiceConnected() 方法中得到从 onBind() 方法中返回的 IBinder 对象，然后可以通过该 对象中的公共方法得到相应的 service 实例，正如 第一个步骤 所说的那样。</p>
<p>d. 在 service 中提供公共方法， 这样就可以在组件（如 Activity 中调用这些公共方法了）</p>
<p>&nbsp;</p>
<p>下面给出一例：</p>
<p>service 代码</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=public%20class%20BindServiceWithIBinder%20extends%20Service%20%7B%0A%0A%09private%20static%20final%20String%20TAG%20%3D%20%22BindServiceWithIBinder%22%3B%0A%0A%09private%20final%20MyIBinder%20myIBinder%20%3D%20new%20MyIBinder()%3B%0A%0A%09%2F**%0A%09%20*%20bindService()%20%E6%97%B6%EF%BC%8C%E8%B0%83%E7%94%A8%E7%9A%84%E6%98%AF%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%EF%BC%8C%E8%80%8C%E9%9D%9E%20onStartCommnad()%20%E6%96%B9%E6%B3%95%0A%09%20*%2F%0A%09%40Override%0A%09public%20IBinder%20onBind(Intent%20intent)%20%7B%0A%09%09%2F%2F%20%E5%9C%A8%E4%B8%BB%20Activity%20%E4%B8%8A%E7%9A%84%20TextView%20%E4%B8%AD%E6%89%93%E5%8D%B0%E5%87%BA%E4%B8%80%E8%A1%8CLOG%0A%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%20%2B%20%22%20----%3E%20onBind%22))%3B%0A%09%09return%20myIBinder%3B%0A%09%7D%0A%0A%09%40Override%0A%09public%20void%20onCreate()%20%7B%0A%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%20%2B%20%22%20----%3E%20onCreate%22))%3B%0A%09%7D%0A%0A%09%40Override%0A%09public%20void%20onDestroy()%20%7B%0A%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%20%2B%20%22%20----%3E%20onDestroy%22))%3B%0A%09%7D%0A%0A%09%40Override%0A%09public%20void%20onRebind(Intent%20intent)%20%7B%0A%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%20%2B%20%22%20----%3E%20onRebind%22))%3B%0A%09%7D%0A%0A%09%40Override%0A%09public%20int%20onStartCommand(Intent%20intent%2C%20int%20flags%2C%20int%20startId)%20%7B%0A%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%20%2B%20%22%20----%3E%20onStartCommand%22))%3B%0A%09%09return%20START_STICKY%3B%0A%09%7D%0A%0A%09%40Override%0A%09public%20boolean%20onUnbind(Intent%20intent)%20%7B%0A%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%20%2B%20%22%20----%3E%20onUnbind%22))%3B%0A%09%09return%20super.onUnbind(intent)%3B%0A%09%7D%0A%0A%09%2F**%0A%09%20*%20%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA%20Binder%20%E7%B1%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB%EF%BC%8C%E4%BE%9B%E5%9C%A8%20onBind()%20%E6%96%B9%E6%B3%95%E4%B8%AD%E8%BF%94%E5%9B%9E%E8%AF%A5%E7%B1%BB%E7%9A%84%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B%0A%09%20*%20%40author%20001718%0A%09%20*%0A%09%20*%2F%0A%09public%20class%20MyIBinder%20extends%20Binder%20%7B%0A%09%09public%20Service%20getService()%20%7B%0A%09%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%0A%09%09%09%09%09%22BindServiceWithIBinder.MyIBinder.getService()%22))%3B%0A%09%09%09return%20BindServiceWithIBinder.this%3B%0A%09%09%7D%0A%09%7D%0A%0A%09%2F**%0A%09%20*%20service%20%E6%8F%90%E4%BE%9B%E7%9A%84%E5%85%AC%E5%85%B1%E6%96%B9%E6%B3%95%EF%BC%8C%E5%9C%A8activity%E4%B8%AD%E5%8F%AF%E4%BB%A5%E8%B0%83%E7%94%A8%0A%09%20*%2F%0A%09public%20void%20download()%20%7B%0A%09%09try%20%7B%0A%09%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%0A%09%09%09%09%09%09%09%2B%20%22%20----%3E%20download()%3A%20%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E4%B8%AD...%22))%3B%0A%09%09%09Thread.sleep(3000)%3B%0A%09%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%20TAG%0A%09%09%09%09%09%09%09%2B%20%22%20----%3E%20download()%3A%20%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%AE%8C%E6%88%90...%22))%3B%0A%09%09%7D%20catch%20(InterruptedException%20e)%20%7B%0A%09%09%09e.printStackTrace()%3B%0A%09%09%7D%0A%09%7D%0A%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;BindServiceWithIBinder&nbsp;</span><span class="keyword">extends</span><span>&nbsp;Service&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;</span><span class="keyword">final</span><span>&nbsp;String&nbsp;TAG&nbsp;=&nbsp;</span><span class="string">"BindServiceWithIBinder"</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;</span><span class="keyword">final</span><span>&nbsp;MyIBinder&nbsp;myIBinder&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;MyIBinder();&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/**</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;bindService()&nbsp;时，调用的是这个方法，而非&nbsp;onStartCommnad()&nbsp;方法</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;IBinder&nbsp;onBind(Intent&nbsp;intent)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;在主&nbsp;Activity&nbsp;上的&nbsp;TextView&nbsp;中打印出一行LOG</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;onBind"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;myIBinder;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;onCreate()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;onCreate"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;onDestroy()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;onDestroy"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;onRebind(Intent&nbsp;intent)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;onRebind"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">int</span><span>&nbsp;onStartCommand(Intent&nbsp;intent,&nbsp;</span><span class="keyword">int</span><span>&nbsp;flags,&nbsp;</span><span class="keyword">int</span><span>&nbsp;startId)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;onStartCommand"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;START_STICKY;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">boolean</span><span>&nbsp;onUnbind(Intent&nbsp;intent)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;onUnbind"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;</span><span class="keyword">super</span><span>.onUnbind(intent);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/**</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;声明一个&nbsp;Binder&nbsp;类的实现类，供在&nbsp;onBind()&nbsp;方法中返回该类的一个实例</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@author&nbsp;001718</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;MyIBinder&nbsp;</span><span class="keyword">extends</span><span>&nbsp;Binder&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;Service&nbsp;getService()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"BindServiceWithIBinder.MyIBinder.getService()"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;BindServiceWithIBinder.</span><span class="keyword">this</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/**</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;service&nbsp;提供的公共方法，在activity中可以调用</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;download()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;download():&nbsp;文件下载中..."</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(<span class="number">3000</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;TAG&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;<span class="string">"&nbsp;----&gt;&nbsp;download():&nbsp;文件下载完成..."</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(InterruptedException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1144521#" pre_index="0" title="Android Service 之三(Bind Service, 继承自 Binder 类)" style="display: none;">public class BindServiceWithIBinder extends Service {

	private static final String TAG = "BindServiceWithIBinder";

	private final MyIBinder myIBinder = new MyIBinder();

	/**
	 * bindService() 时，调用的是这个方法，而非 onStartCommnad() 方法
	 */
	@Override
	public IBinder onBind(Intent intent) {
		// 在主 Activity 上的 TextView 中打印出一行LOG
		MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
				MyServiceActivity.UPDATE_VIEW, TAG + " ----&gt; onBind"));
		return myIBinder;
	}

	@Override
	public void onCreate() {
		MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
				MyServiceActivity.UPDATE_VIEW, TAG + " ----&gt; onCreate"));
	}

	@Override
	public void onDestroy() {
		MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
				MyServiceActivity.UPDATE_VIEW, TAG + " ----&gt; onDestroy"));
	}

	@Override
	public void onRebind(Intent intent) {
		MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
				MyServiceActivity.UPDATE_VIEW, TAG + " ----&gt; onRebind"));
	}

	@Override
	public int onStartCommand(Intent intent, int flags, int startId) {
		MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
				MyServiceActivity.UPDATE_VIEW, TAG + " ----&gt; onStartCommand"));
		return START_STICKY;
	}

	@Override
	public boolean onUnbind(Intent intent) {
		MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
				MyServiceActivity.UPDATE_VIEW, TAG + " ----&gt; onUnbind"));
		return super.onUnbind(intent);
	}

	/**
	 * 声明一个 Binder 类的实现类，供在 onBind() 方法中返回该类的一个实例
	 * @author 001718
	 *
	 */
	public class MyIBinder extends Binder {
		public Service getService() {
			MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
					MyServiceActivity.UPDATE_VIEW,
					"BindServiceWithIBinder.MyIBinder.getService()"));
			return BindServiceWithIBinder.this;
		}
	}

	/**
	 * service 提供的公共方法，在activity中可以调用
	 */
	public void download() {
		try {
			MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
					MyServiceActivity.UPDATE_VIEW, TAG
							+ " ----&gt; download(): 文件下载中..."));
			Thread.sleep(3000);
			MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
					MyServiceActivity.UPDATE_VIEW, TAG
							+ " ----&gt; download(): 文件下载完成..."));
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
}</pre>
<p>&nbsp;主 Activity 中的相应关键代码为：</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=private%20void%20doUnbindService()%20%7B%0A%09%09if%20(isBound)%20%7B%0A%09%09%09unbindService(myLocalServiceConnection)%3B%0A%09%09%09isBound%20%3D%20false%3B%0A%09%09%7D%0A%09%7D%0A%0A%09private%20void%20doBindService()%20%7B%0A%09%09Log.i(%22bind%22%2C%20%22begin%20to%20bind%22)%3B%0A%09%09bindService(intent%2C%20myLocalServiceConnection%2C%20Context.BIND_AUTO_CREATE)%3B%0A%0A%09%7D%0A%0A%09private%20ServiceConnection%20myLocalServiceConnection%20%3D%20new%20ServiceConnection()%20%7B%0A%09%09public%20void%20onServiceConnected(android.content.ComponentName%20name%2C%0A%09%09%09%09android.os.IBinder%20service)%20%7B%0A%09%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%0A%09%09%09%09%09%22myServiceConnection.onServiceConnected%22))%3B%0A%09%09%09%2F%2F%20%E5%9B%A0%E4%B8%BA%20%E5%AE%A2%E6%88%B7%E7%AB%AF%20%E4%B8%8E%20%E6%9C%8D%E5%8A%A1%20%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E5%86%85%EF%BC%8C%E8%BF%99%E6%A0%B7%E4%B8%80%E6%9D%A5%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9F%A5%E9%81%93%E5%8F%82%E6%95%B0%20%22service%22%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BA%86%EF%BC%8C%E4%B9%9F%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E6%98%BE%E7%A4%BA%E7%9A%84%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E4%BA%86%E3%80%82%0A%09%09%09%2F%2F%20%E8%80%8C%E5%A6%82%E6%9E%9C%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E4%B8%8D%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E8%AF%9D%EF%BC%8C%E9%82%A3%E4%B9%88%E6%AD%A4%E5%A4%84%E6%98%AF%E4%B8%8D%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E6%98%BE%E7%A4%BA%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E7%9A%84%EF%BC%8C%0A%09%09%09%2F%2F%20%E5%9B%A0%E4%B8%BA%EF%BC%8C%E9%80%9A%E8%BF%87Debug%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E6%AD%A4%E6%97%B6%E4%BC%A0%E8%BF%9B%E6%9D%A5%E7%9A%84%20Service%20%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%98%AF%20BinderProxy%0A%09%09%09MyIBinder%20myIBinder%20%3D%20(MyIBinder)%20service%3B%0A%09%09%09bsi%20%3D%20(BindServiceWithIBinder)%20myIBinder.getService()%3B%0A%09%09%09isBound%20%3D%20true%3B%0A%0A%09%09%09bsi.download()%3B%0A%09%09%7D%3B%0A%0A%09%09public%20void%20onServiceDisconnected(android.content.ComponentName%20name)%20%7B%0A%09%09%09MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(%0A%09%09%09%09%09MyServiceActivity.UPDATE_VIEW%2C%0A%09%09%09%09%09%22myServiceConnection.onServiceDisconnected%22))%3B%0A%09%09%09isBound%20%3D%20false%3B%0A%09%09%7D%3B%0A%09%7D%3B" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="keyword">private</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;doUnbindService()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(isBound)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unbindService(myLocalServiceConnection);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isBound&nbsp;=&nbsp;<span class="keyword">false</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;doBindService()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log.i(<span class="string">"bind"</span><span>,&nbsp;</span><span class="string">"begin&nbsp;to&nbsp;bind"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bindService(intent,&nbsp;myLocalServiceConnection,&nbsp;Context.BIND_AUTO_CREATE);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span><span>&nbsp;ServiceConnection&nbsp;myLocalServiceConnection&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;ServiceConnection()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;onServiceConnected(android.content.ComponentName&nbsp;name,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android.os.IBinder&nbsp;service)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"myServiceConnection.onServiceConnected"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;因为&nbsp;客户端&nbsp;与&nbsp;服务&nbsp;在同一个进程内，这样一来，就可以知道参数&nbsp;"service"的类型了，也就可以进行显示的强制类型转换了。</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;而如果&nbsp;客户端与服务不在同一个进程中的话，那么此处是不可以进行显示强制类型转换的，</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;因为，通过Debug，可以发现此时传进来的&nbsp;Service&nbsp;的类型是&nbsp;BinderProxy</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyIBinder&nbsp;myIBinder&nbsp;=&nbsp;(MyIBinder)&nbsp;service;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bsi&nbsp;=&nbsp;(BindServiceWithIBinder)&nbsp;myIBinder.getService();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isBound&nbsp;=&nbsp;<span class="keyword">true</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bsi.download();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;onServiceDisconnected(android.content.ComponentName&nbsp;name)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyServiceActivity.UPDATE_VIEW,&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"myServiceConnection.onServiceDisconnected"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isBound&nbsp;=&nbsp;<span class="keyword">false</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="java" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1144521#" pre_index="1" title="Android Service 之三(Bind Service, 继承自 Binder 类)" style="display: none;">private void doUnbindService() {
		if (isBound) {
			unbindService(myLocalServiceConnection);
			isBound = false;
		}
	}

	private void doBindService() {
		Log.i("bind", "begin to bind");
		bindService(intent, myLocalServiceConnection, Context.BIND_AUTO_CREATE);

	}

	private ServiceConnection myLocalServiceConnection = new ServiceConnection() {
		public void onServiceConnected(android.content.ComponentName name,
				android.os.IBinder service) {
			MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
					MyServiceActivity.UPDATE_VIEW,
					"myServiceConnection.onServiceConnected"));
			// 因为 客户端 与 服务 在同一个进程内，这样一来，就可以知道参数 "service"的类型了，也就可以进行显示的强制类型转换了。
			// 而如果 客户端与服务不在同一个进程中的话，那么此处是不可以进行显示强制类型转换的，
			// 因为，通过Debug，可以发现此时传进来的 Service 的类型是 BinderProxy
			MyIBinder myIBinder = (MyIBinder) service;
			bsi = (BindServiceWithIBinder) myIBinder.getService();
			isBound = true;

			bsi.download();
		};

		public void onServiceDisconnected(android.content.ComponentName name) {
			MyServiceActivity.vh.sendMessage(MyServiceActivity.createMessage(
					MyServiceActivity.UPDATE_VIEW,
					"myServiceConnection.onServiceDisconnected"));
			isBound = false;
		};
	};</pre>
<p>&nbsp;</p>
<p>&nbsp;下面来看运行效果：</p>
<p>连续点击两次 Bind Service </p>
<p><br><img alt="" src="images/8e5afb98-e154-3c55-b267-e02058731c13.jpg"><br>&nbsp;&nbsp;</p>
<p>从此图中可以看出，bind service 的响应过程。也可以看到，第二次点击时，service 没作任何反应，因为当前 Activity 在第一次点击后就已经跟此service绑定了。</p>
<p>点击 Unbind Service </p>
<p><br><img alt="" src="images/8e008fde-6df8-3b82-861e-e87c7990ef47.jpg"><br>&nbsp;至此，该 service 的生命周期结束，它也会被系统给停掉以回收资源。</p>
<p>&nbsp;</p>
  </div>