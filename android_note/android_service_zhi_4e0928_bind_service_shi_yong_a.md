# Android Service 之三(Bind Service,使用 AIDL)


<div id="blog_content" class="blog_content">
    <p>前面写了 Bind Service 的两种实现方式，接下来转一篇贴子来简述一下最后一种实现方式<br><span style="color: #ff0000;"><strong>第三种：使用 AIDL</strong></span></p>
<p><span style="color: #ff0000;"><span style="color: #000000;">前面讲的使用 Messenger 技术，其实是基于 AIDL架构的，但是 Messenger 使用一个队列来处理所有的请求，这样一来，就无法进行多线程的并发了。所以，如果你想同时接受并处理多个 client 的请求，那么请使用 AIDL 来实现，但这样的话，你需要小心地进行同步处理了哦~</span><br></span>默认情况下，一个应用不管有多少个 Activity、Service 或其他组件，它们都是运行在一个进程上，但是我们可以安排 Service 运行一个新的进程上，但是不同进程之间应该如何通信呢？当需要在不同的进程之间传递对象时，应该怎么做呢？AIDL(Android Interface Definition Language) 便是解决这一问题的钥匙。<br>使用 AIDL 并不是难事，但是比较繁琐，并且一不小心容易出错。好在 Android Dev Guide 的 "AIDL" 章节（在 "Dev Guide " 左侧列表的最下面）对这个问题讲解非常详细，再结合 Android APIDemo 中的 Remote Service Binding 给出了的示例，这都给了开发者提供了非常到位的帮助。以下内容就是我结合二者，整理出来的笔记，力求真理，但能力有限，差错难免，请读者坚持自己的判断力，本文只供参考，且不可尽信。 </p>
<p>一、使用 AIDL 实现 IPC<br>面对问题，应统揽全局，归纳阶段，划定步骤，共得出四大步，分列如下：<br>① 创建.aidl 文件<br>&nbsp;&nbsp;&nbsp; 在这个文件里定义 method 和 field<br>② 把 .aidl 文件加入到 makefile 中去<br>&nbsp;&nbsp;&nbsp; 如果使用 Eclipse 则 ADT 会帮你管理<br>③ 实现接口方法<br>&nbsp;&nbsp;&nbsp; AIDL 编译器会根据接口生成一个用 Java 语言编写的interface，这个 interface 有一个抽象的内部类，名字为 Stub，你必须创建一个类，继承于它，并且实现 .adil 文件中所声明的方法<br>④ 公开接口给客户端<br>&nbsp;&nbsp;&nbsp; 如果创建的是 service，则应该继承自 Service，并且重载 Service.onBind() 返回实现接口的类的实例</p>
<p>这四个步骤在 Remote Service Binding 中均有所呈现，以下分开阐述。Remote Service Binding 共包含有两个 .java 文件，三个 .aidl 文件，物理结构比较简单，但是逻辑结构就不那么简单，以下用 Class Diagram 来展示其中的关系。</p>
<p><br><img alt="" src="images/571c71f5-996e-3ac3-bc85-c76ede22b93e.jpg" title="点击查看原始大小图片" class="magplus" width="700" height="491"><br>&nbsp;</p>
<p>1、创建.aidl 文件<br>AIDL 语法简单，用来声明接口，其中的方法接收参数和返回值，但是参数和返回值的类型是有约束的，且有些类型是需要 import，另外一些则无需这样做。<br>AIDL 支持的数据类型划分为四类，第一类是 Java 编程语言中的基本类型，第二类包括 String、List、Map 和 CharSequence，第三类是其他 AIDL 生成的 interface，第四类是实现了 Parcelable 接口的自定义类。<br>其中，除了第一类外，其他三类在使用时均需要特别小心。<br>使用第二类时，首先需要明白这些类不需要 import，是内嵌的。其次注意在使用 List 和 Map 此二者容器类时，需注意其元素必须得是 AIDL 支持的数据类型，List 可支持泛型，但是 Map 不支持，同时另外一端负责接收的具体的类里则必须是 ArrayList 和 HashMap。<br>使用第三、四类时，需要留意它们都是需要 import 的，但是前者传递时，传递的是 reference，而后者则是 value。</p>
<p>在创建 .aidl 文件的过程中，应该注意一旦 method 有参数，则需注意在前面加上 in, out 或 inout，它们被称为 directional tag，但是对于基本类型的参数，默认就是 in，并且不能为其他值。</p>
<p>Remote Service Binding 共包括了三个 .aidl 文件，分别是IRemoteService.aidl、IRemoteServiceCallback.aidl、ISecondary.aidl，通过它们可以看到如何使用第一类和第三类的数据类型，稀罕的是，看不到第二类、第四类数据类型的使用，也没有看到 directional tag。</p>
<p>&nbsp;</p>
<p>2、实现 Interface<br>AIDL 为你生成一个 interface 文件，文件名称和 .aidl 文件相同。如果使用 Eclipse 插件，则 AIDL 会在构建过程中自动运行，如果不使用插件，则需要先使用 AIDL。<br>生成的 interface 会包含一个抽象内部类 Stub，它声明了在 .aidl 文件里的所有方法。要想实现你在 .aidl 文件里定义的接口，就必须实现这个Stub类，如下：</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%2F**%0A%20*%20This%20implementation%20is%20used%20to%20receive%20callbacks%20from%20the%20remote%0A%20*%20service.%0A%20*%2F%0Aprivate%20IRemoteServiceCallback%20mCallback%20%3D%20new%20IRemoteServiceCallback.Stub()%20%7B%0A%09%2F**%0A%09%20*%20This%20is%20called%20by%20the%20remote%20service%20regularly%20to%20tell%20us%20about%0A%09%20*%20new%20values.%20%20Note%20that%20IPC%20calls%20are%20dispatched%20through%20a%20thread%0A%09%20*%20pool%20running%20in%20each%20process%2C%20so%20the%20code%20executing%20here%20will%0A%09%20*%20NOT%20be%20running%20in%20our%20main%20thread%20like%20most%20other%20things%20--%20so%2C%0A%09%20*%20to%20update%20the%20UI%2C%20we%20need%20to%20use%20a%20Handler%20to%20hop%20over%20there.%0A%09%20*%2F%0A%09public%20void%20valueChanged(int%20value)%20%7B%0A%09%09mHandler.sendMessage(mHandler.obtainMessage(BUMP_MSG%2C%20value%2C%200))%3B%0A%09%7D%0A%7D%3B" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">/**</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;*&nbsp;This&nbsp;implementation&nbsp;is&nbsp;used&nbsp;to&nbsp;receive&nbsp;callbacks&nbsp;from&nbsp;the&nbsp;remote</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;*&nbsp;service.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">private</span><span>&nbsp;IRemoteServiceCallback&nbsp;mCallback&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;IRemoteServiceCallback.Stub()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/**</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;remote&nbsp;service&nbsp;regularly&nbsp;to&nbsp;tell&nbsp;us&nbsp;about</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;new&nbsp;values.&nbsp;&nbsp;Note&nbsp;that&nbsp;IPC&nbsp;calls&nbsp;are&nbsp;dispatched&nbsp;through&nbsp;a&nbsp;thread</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;pool&nbsp;running&nbsp;in&nbsp;each&nbsp;process,&nbsp;so&nbsp;the&nbsp;code&nbsp;executing&nbsp;here&nbsp;will</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NOT&nbsp;be&nbsp;running&nbsp;in&nbsp;our&nbsp;main&nbsp;thread&nbsp;like&nbsp;most&nbsp;other&nbsp;things&nbsp;--&nbsp;so,</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;update&nbsp;the&nbsp;UI,&nbsp;we&nbsp;need&nbsp;to&nbsp;use&nbsp;a&nbsp;Handler&nbsp;to&nbsp;hop&nbsp;over&nbsp;there.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;valueChanged(</span><span class="keyword">int</span><span>&nbsp;value)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mHandler.sendMessage(mHandler.obtainMessage(BUMP_MSG,&nbsp;value,&nbsp;<span class="number">0</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>};&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149790#" pre_index="0" title="Android Service 之三(Bind Service,使用 AIDL)" style="display: none;">/**
 * This implementation is used to receive callbacks from the remote
 * service.
 */
private IRemoteServiceCallback mCallback = new IRemoteServiceCallback.Stub() {
	/**
	 * This is called by the remote service regularly to tell us about
	 * new values.  Note that IPC calls are dispatched through a thread
	 * pool running in each process, so the code executing here will
	 * NOT be running in our main thread like most other things -- so,
	 * to update the UI, we need to use a Handler to hop over there.
	 */
	public void valueChanged(int value) {
		mHandler.sendMessage(mHandler.obtainMessage(BUMP_MSG, value, 0));
	}
};</pre>
<p>&nbsp;</p>
<p>Stub 也定义了一些帮助方法，比较常用的有 asInterface()，其接收一个 IBinder 作为参数，并且返回一个 interface 的实例用来调用IPC方法。</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=private%20static%20INotificationManager%20sService%3B%0A%20%0Astatic%20private%20INotificationManager%20getService()%0A%7B%0A%09if%20(sService%20!%3D%20null)%20%7B%0A%09%09return%20sService%3B%0A%09%7D%0A%09sService%20%3D%20INotificationManager.Stub.asInterface(ServiceManager.getService(%22notification%22))%3B%0A%09return%20sService%3B%0A%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="keyword">private</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;INotificationManager&nbsp;sService;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;</span></li><li><span><span class="keyword">static</span><span>&nbsp;</span><span class="keyword">private</span><span>&nbsp;INotificationManager&nbsp;getService()&nbsp;&nbsp;</span></span></li><li><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(sService&nbsp;!=&nbsp;</span><span class="keyword">null</span><span>)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;sService;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;sService&nbsp;=&nbsp;INotificationManager.Stub.asInterface(ServiceManager.getService(<span class="string">"notification"</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;sService;&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149790#" pre_index="1" title="Android Service 之三(Bind Service,使用 AIDL)" style="display: none;">private static INotificationManager sService;
 
static private INotificationManager getService()
{
	if (sService != null) {
		return sService;
	}
	sService = INotificationManager.Stub.asInterface(ServiceManager.getService("notification"));
	return sService;
}</pre>
<p>&nbsp;</p>
<p>&nbsp;要实现 interface，需要继承 Stub，实现其方法，这在 RemoteService 和 RemoteServiceBinding 都可以找到相关代码。</p>
<p>这个环节是重中之重，需要特别小心的有两点，其一是抛出的所有异常均不会发给调用者；其二是IPC调用是同步的，这意味IPC服务一旦花费较长时间完成的话，就会引起ANR，应该将这样的操作放在单独的线程里。</p>
<p>&nbsp;</p>
<p>3、向客户端公开 Interface<br>独乐乐不如众乐乐，需要将服务公开出去，要达成这个目的，须得创建一个 Service 的子类，并且实现 Service.onBind(Intent)，通过这个方法将实现了接口的类的实例返回回来。通过查看 RemoteService 一目了然。</p>
<p>&nbsp;</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%40Override%0Apublic%20IBinder%20onBind(Intent%20intent)%20%7B%0A%09%2F%2F%20Select%20the%20interface%20to%20return.%20%20If%20your%20service%20only%20implements%0A%09%2F%2F%20a%20single%20interface%2C%20you%20can%20just%20return%20it%20here%20without%20checking%0A%09%2F%2F%20the%20Intent.%0A%09if%20(IRemoteService.class.getName().equals(intent.getAction()))%20%7B%0A%09%09return%20mBinder%3B%0A%09%7D%0A%09if%20(ISecondary.class.getName().equals(intent.getAction()))%20%7B%0A%09%09return%20mSecondaryBinder%3B%0A%09%7D%0A%09return%20null%3B%0A%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">public</span><span>&nbsp;IBinder&nbsp;onBind(Intent&nbsp;intent)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Select&nbsp;the&nbsp;interface&nbsp;to&nbsp;return.&nbsp;&nbsp;If&nbsp;your&nbsp;service&nbsp;only&nbsp;implements</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;a&nbsp;single&nbsp;interface,&nbsp;you&nbsp;can&nbsp;just&nbsp;return&nbsp;it&nbsp;here&nbsp;without&nbsp;checking</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;the&nbsp;Intent.</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(IRemoteService.</span><span class="keyword">class</span><span>.getName().equals(intent.getAction()))&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;mBinder;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(ISecondary.</span><span class="keyword">class</span><span>.getName().equals(intent.getAction()))&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;mSecondaryBinder;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;</span><span class="keyword">null</span><span>;&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149790#" pre_index="2" title="Android Service 之三(Bind Service,使用 AIDL)" style="display: none;">@Override
public IBinder onBind(Intent intent) {
	// Select the interface to return.  If your service only implements
	// a single interface, you can just return it here without checking
	// the Intent.
	if (IRemoteService.class.getName().equals(intent.getAction())) {
		return mBinder;
	}
	if (ISecondary.class.getName().equals(intent.getAction())) {
		return mSecondaryBinder;
	}
	return null;
}</pre>
<p>&nbsp;</p>
<p>其中的 mBinder 和 mSecondaryBinder 分别是实现了 IRemoteService 和 ISecondary 接口的类的实例。</p>
<p>4、使用Parcelables传值<br>前文中提到 Remote Servcie Binding 没有使用第四类数据类型作为参数，这是示例的不足，要想让一个类变成第四类，需要遵照以下步骤：</p>
<p>① 引入 Parcelable 接口<br>② 实现 writeToParcel(Parcel out)<br>③ 增加一个静态的field，其实现 Parcelable.Creator 接口<br>④ 创建一个 .aidl 文件，用以声明你的 parcelables 类<br>在 "AIDL" 中，类 Rect 是一个不错的示例，弥补了 Remote Service Binding 的不足。</p>
<p>&nbsp;</p>
<p>二、调用 IPC 方法<br>万事俱备，只欠东风，IPC 备妥，只待调用。在 Remote Service Binding 中，RemoteServiceBinding 正是 IPC 的调用者，既然要使用接口，那就先声明 interface 类型的变量</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%2F%2F%20The%20primary%20interface%20we%20will%20be%20calling%20on%20the%20service.%20%0AIRemoteService%20mService%20%3D%20null%3B%20%0A%2F%2F%20Another%20interface%20we%20use%20on%20the%20service.%20%0AISecondary%20mSecondaryService%20%3D%20null%3B%20" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//&nbsp;The&nbsp;primary&nbsp;interface&nbsp;we&nbsp;will&nbsp;be&nbsp;calling&nbsp;on&nbsp;the&nbsp;service.&nbsp;</span><span>&nbsp;&nbsp;</span></span></li><li><span>IRemoteService&nbsp;mService&nbsp;=&nbsp;<span class="keyword">null</span><span>;&nbsp;&nbsp;&nbsp;</span></span></li><li><span><span class="comment">//&nbsp;Another&nbsp;interface&nbsp;we&nbsp;use&nbsp;on&nbsp;the&nbsp;service.&nbsp;</span><span>&nbsp;&nbsp;</span></span></li><li><span>ISecondary&nbsp;mSecondaryService&nbsp;=&nbsp;<span class="keyword">null</span><span>;&nbsp;&nbsp;&nbsp;</span></span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149790#" pre_index="3" title="Android Service 之三(Bind Service,使用 AIDL)" style="display: none;">// The primary interface we will be calling on the service. 
IRemoteService mService = null; 
// Another interface we use on the service. 
ISecondary mSecondaryService = null; </pre>
<p>&nbsp;</p>
<p>实现 ServiceConnection，在 onServiceConnected(ComponentName className, IBinder service) 中完成对 mService 和 mSecondaryService 的赋值。</p>
<p>&nbsp;</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=private%20ServiceConnection%20mConnection%20%3D%20new%20ServiceConnection()%20%7B%0A%09public%20void%20onServiceConnected(ComponentName%20className%2C%0A%09%09%09IBinder%20service)%20%7B%0A%09%09mService%20%3D%20IRemoteService.Stub.asInterface(service)%3B%0A%09%09%2F%2F%20...%20%E4%BB%A5%E4%B8%8B%E7%9C%81%E7%95%A5%0A%09%7D%0A%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="keyword">private</span><span>&nbsp;ServiceConnection&nbsp;mConnection&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;ServiceConnection()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;onServiceConnected(ComponentName&nbsp;className,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IBinder&nbsp;service)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mService&nbsp;=&nbsp;IRemoteService.Stub.asInterface(service);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;...&nbsp;以下省略</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149790#" pre_index="4" title="Android Service 之三(Bind Service,使用 AIDL)" style="display: none;">private ServiceConnection mConnection = new ServiceConnection() {
	public void onServiceConnected(ComponentName className,
			IBinder service) {
		mService = IRemoteService.Stub.asInterface(service);
		// ... 以下省略
	}
}</pre>
<p>&nbsp;</p>
<p>接着别忘了调用 Context.bindService()，完成任务以后，调用 Context.unbindService()。如果在 connection 中断的情况下，调用 IPC 方法，你会遇到 DeadObjectException，这是 remote method 能抛出的唯一异常。</p>
<p>&nbsp;</p>
<p>原文地址： <a href="http://www.poemcode.net/2010/05/aidl-ipc/">http://www.poemcode.net/2010/05/aidl-ipc/</a></p>
  </div>