# Android Service 之三(Bind Service,使用 Messenger)


<div id="blog_content" class="blog_content">
    <p><span style="color: #ff0000;"><span style="color: #000000;">上次讲了第一种 Bind Service 的实现方式，今天讲</span></span></p>
<p><span style="color: #ff0000;"><strong>第二种：</strong></span><span style="color: #ff0000;"><strong>使用 Messenger</strong></span></p>
<p>这种情况适用于你想实现进程间通信的场合，它分以下几个步骤：</p>
<p>①&nbsp;service 内部需要有一个 Handler 的实现，它被用来处理从每一个 client 发送过的来请求</p>
<p>② 通过这个 Handler ，来生成一个 Messenger</p>
<p>③ 在 service 的onBind() 方法中，需要向 client 返回由该 Messenger 生成的一个 IBinder 实例</p>
<p>④&nbsp;client 使用从 service 返回的 IBinder 实例来初始化一个 Messenger， 然后使用该&nbsp;Messenger 与 service 进行通信</p>
<p>⑤ service 通过它自身内部的 Handler 实现(Handler 人 handleMessage() 方法中)来处理从 client 发送过来的请求</p>
<p>&nbsp;</p>
<p>下面给出一实例进行说明，该实现由两个工程组成：</p>
<p>① BindServiceDemo_Client： 该工程中只包含一个Activity，用来绑定另一个工程中的 Service</p>
<p>② BindServiceDemo_Service：该工程中只包含一个Service</p>
<p>在实例中， Client 与 Service 中都有一个Messenger ，所以可以进行两者的互相请求与应答。话不多说，贴上部分源码：</p>
<p>① BindServiceDemoClient 中：&nbsp;</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%2F%2F%20client%20%E7%AB%AF%20Handler%20%E7%9A%84%E5%AE%9E%E7%8E%B0%0Aprivate%20class%20IncomingHandler%20extends%20Handler%20%7B%0A%09%09%2F*%0A%09%09%20*%20%E5%A4%84%E7%90%86%E4%BB%8EService%E5%8F%91%E9%80%81%E8%87%B3%E8%AF%A5Activity%E7%9A%84%E6%B6%88%E6%81%AF%0A%09%09%20*%20(non-Javadoc)%0A%09%09%20*%20%40see%20android.os.Handler%23handleMessage(android.os.Message)%0A%09%09%20*%2F%0A%09%09%40Override%0A%09%09public%20void%20handleMessage(Message%20msg)%20%7B%0A%09%09%09switch%20(msg.what)%20%7B%0A%09%09%09%09case%20MSG_SET_VALUE%3A%0A%09%09%09%09%09Toast.makeText(BindServiceDemoClient.this%2C%0A%09%09%09%09%09%09%09%22set%20value%20as%3A%20%22%20%2B%20msg.arg1%2C%20Toast.LENGTH_SHORT)%0A%09%09%09%09%09%09%09.show()%3B%0A%09%09%09%09%09break%3B%0A%09%09%09%09default%3A%0A%09%09%09%09%09super.handleMessage(msg)%3B%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//&nbsp;client&nbsp;端&nbsp;Handler&nbsp;的实现</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">private</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;IncomingHandler&nbsp;</span><span class="keyword">extends</span><span>&nbsp;Handler&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;处理从Service发送至该Activity的消息</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(non-Javadoc)</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;android.os.Handler#handleMessage(android.os.Message)</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;handleMessage(Message&nbsp;msg)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">switch</span><span>&nbsp;(msg.what)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">case</span><span>&nbsp;MSG_SET_VALUE:&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Toast.makeText(BindServiceDemoClient.<span class="keyword">this</span><span>,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"set&nbsp;value&nbsp;as:&nbsp;"</span><span>&nbsp;+&nbsp;msg.arg1,&nbsp;Toast.LENGTH_SHORT)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.show();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">default</span><span>:&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">super</span><span>.handleMessage(msg);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149756#" pre_index="0" title="Android Service 之三(Bind Service,使用 Messenger)" style="display: none;">// client 端 Handler 的实现
private class IncomingHandler extends Handler {
		/*
		 * 处理从Service发送至该Activity的消息
		 * (non-Javadoc)
		 * @see android.os.Handler#handleMessage(android.os.Message)
		 */
		@Override
		public void handleMessage(Message msg) {
			switch (msg.what) {
				case MSG_SET_VALUE:
					Toast.makeText(BindServiceDemoClient.this,
							"set value as: " + msg.arg1, Toast.LENGTH_SHORT)
							.show();
					break;
				default:
					super.handleMessage(msg);
			}
		}
	}</pre>
<p>&nbsp;</p>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%2F%2F%20client%20%E7%AB%AF%20ServiceConnection%20%E7%9A%84%E5%AE%9E%E7%8E%B0%0Aprivate%20ServiceConnection%20myRemoteServiceConnection%20%3D%20new%20ServiceConnection()%20%7B%0A%09%09public%20void%20onServiceConnected(android.content.ComponentName%20name%2C%0A%09%09%09%09android.os.IBinder%20service)%20%7B%0A%09%09%09updateLog(%22myServiceConnection.onServiceConnected%22)%3B%0A%09%09%09%2F%2F%20%E5%AE%A2%E6%88%B7%E7%AB%AF%20%E4%B8%8E%20%E6%9C%8D%E5%8A%A1%20%E4%B8%8D%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E8%AF%9D%EF%BC%8C%E6%89%80%E4%BB%A5%E4%B8%8D%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E6%98%BE%E7%A4%BA%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E7%9A%84%EF%BC%8C%0A%09%09%09%2F%2F%20%E5%9B%A0%E4%B8%BA%EF%BC%8C%E9%80%9A%E8%BF%87Debug%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E6%AD%A4%E6%97%B6%E4%BC%A0%E8%BF%9B%E6%9D%A5%E7%9A%84%20Service%20%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%98%AF%20BinderProxy%0A%09%09%09isBound%20%3D%20true%3B%0A%09%09%09%2F%2F%20%E4%BD%BF%E7%94%A8%E4%BB%8EService%E8%BF%94%E5%9B%9E%E7%9A%84IBinder%E6%9D%A5%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAMessenger%0A%09%09%09Messenger%20serviceMessenger%20%3D%20new%20Messenger(service)%3B%0A%09%09%09%2F%2F%20%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAMessage%0A%09%09%09Message%20msg%20%3D%20Message.obtain()%3B%0A%09%09%09msg.what%20%3D%20MSG_REGISTER_CLIENT%3B%0A%09%09%09msg.replyTo%20%3D%20messenger%3B%0A%09%09%09try%20%7B%0A%09%09%09%09%2F%2F%20%E5%90%91Service%20%E5%8F%91%E9%80%81Message%0A%09%09%09%09serviceMessenger.send(msg)%3B%0A%09%09%09%7D%20catch%20(RemoteException%20e)%20%7B%0A%09%09%09%09e.printStackTrace()%3B%0A%09%09%09%7D%0A%0A%09%09%09msg%20%3D%20Message.obtain()%3B%0A%09%09%09msg.what%20%3D%20MSG_SET_VALUE%3B%0A%09%09%09msg.replyTo%20%3D%20messenger%3B%0A%09%09%09msg.arg1%20%3D%2010%3B%0A%09%09%09try%20%7B%0A%09%09%09%09serviceMessenger.send(msg)%3B%0A%09%09%09%7D%20catch%20(RemoteException%20e)%20%7B%0A%09%09%09%09e.printStackTrace()%3B%0A%09%09%09%7D%0A%09%09%7D%3B%0A" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//&nbsp;client&nbsp;端&nbsp;ServiceConnection&nbsp;的实现</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">private</span><span>&nbsp;ServiceConnection&nbsp;myRemoteServiceConnection&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;ServiceConnection()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;onServiceConnected(android.content.ComponentName&nbsp;name,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android.os.IBinder&nbsp;service)&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateLog(<span class="string">"myServiceConnection.onServiceConnected"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;客户端&nbsp;与&nbsp;服务&nbsp;不在同一个进程中的话，所以不可以进行显示强制类型转换的，</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;因为，通过Debug，可以发现此时传进来的&nbsp;Service&nbsp;的类型是&nbsp;BinderProxy</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isBound&nbsp;=&nbsp;<span class="keyword">true</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;使用从Service返回的IBinder来生成一个Messenger</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Messenger&nbsp;serviceMessenger&nbsp;=&nbsp;<span class="keyword">new</span><span>&nbsp;Messenger(service);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;生成一个Message</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Message&nbsp;msg&nbsp;=&nbsp;Message.obtain();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.what&nbsp;=&nbsp;MSG_REGISTER_CLIENT;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.replyTo&nbsp;=&nbsp;messenger;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;向Service&nbsp;发送Message</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceMessenger.send(msg);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(RemoteException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg&nbsp;=&nbsp;Message.obtain();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.what&nbsp;=&nbsp;MSG_SET_VALUE;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.replyTo&nbsp;=&nbsp;messenger;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.arg1&nbsp;=&nbsp;<span class="number">10</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceMessenger.send(msg);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(RemoteException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149756#" pre_index="1" title="Android Service 之三(Bind Service,使用 Messenger)" style="display: none;">// client 端 ServiceConnection 的实现
private ServiceConnection myRemoteServiceConnection = new ServiceConnection() {
		public void onServiceConnected(android.content.ComponentName name,
				android.os.IBinder service) {
			updateLog("myServiceConnection.onServiceConnected");
			// 客户端 与 服务 不在同一个进程中的话，所以不可以进行显示强制类型转换的，
			// 因为，通过Debug，可以发现此时传进来的 Service 的类型是 BinderProxy
			isBound = true;
			// 使用从Service返回的IBinder来生成一个Messenger
			Messenger serviceMessenger = new Messenger(service);
			// 生成一个Message
			Message msg = Message.obtain();
			msg.what = MSG_REGISTER_CLIENT;
			msg.replyTo = messenger;
			try {
				// 向Service 发送Message
				serviceMessenger.send(msg);
			} catch (RemoteException e) {
				e.printStackTrace();
			}

			msg = Message.obtain();
			msg.what = MSG_SET_VALUE;
			msg.replyTo = messenger;
			msg.arg1 = 10;
			try {
				serviceMessenger.send(msg);
			} catch (RemoteException e) {
				e.printStackTrace();
			}
		};
</pre>
<p>&nbsp;&nbsp;</p>
<p>② BindServiceDemoService 中：</p>
<div class="dp-highlighter">
<div class="bar">
<div class="tools">Java代码 <a href="#" title="复制代码"><img alt="复制代码" src="/images/icon_copy.gif"></a> </div>
</div>
</div>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%2F%2F%20service%20%E7%AB%AF%E7%9A%84%20Handler%20%E7%9A%84%E5%AE%9E%E7%8E%B0%0Aprivate%20class%20IncomingHandler%20extends%20Handler%20%7B%0A%0A%09%09%40Override%0A%09%09public%20void%20handleMessage(Message%20msg)%20%7B%0A%09%09%09switch%20(msg.what)%20%7B%0A%09%09%09%09case%20MSG_REGISTER_CLIENT%3A%0A%09%09%09%09%09allClients.add(msg.replyTo)%3B%0A%09%09%09%09%09break%3B%0A%09%09%09%09case%20MSG_UNREGISTER_CLIENT%3A%0A%09%09%09%09%09allClients.remove(msg.replyTo)%3B%0A%09%09%09%09%09break%3B%0A%09%09%09%09case%20MSG_SET_VALUE%3A%0A%09%09%09%09%09int%20value%20%3D%20msg.arg1%3B%0A%09%09%09%09%09for%20(int%20i%20%3D%200%3B%20i%20%3C%20allClients.size()%3B%20i%2B%2B)%20%7B%0A%09%09%09%09%09%09try%20%7B%0A%09%09%09%09%09%09%09allClients.get(i).send(%0A%09%09%09%09%09%09%09%09%09Message.obtain(null%2C%20MSG_SET_VALUE%2C%20value%2C%0A%09%09%09%09%09%09%09%09%09%09%090))%3B%0A%09%09%09%09%09%09%7D%20catch%20(RemoteException%20e)%20%7B%0A%09%09%09%09%09%09%09allClients.remove(i)%3B%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%7D%0A%09%09%09%09%09break%3B%0A%09%09%09%09default%3A%0A%09%09%09%09%09super.handleMessage(msg)%3B%0A%09%09%09%7D%0A%09%09%7D%0A%0A%09%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="comment">//&nbsp;service&nbsp;端的&nbsp;Handler&nbsp;的实现</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">private</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;IncomingHandler&nbsp;</span><span class="keyword">extends</span><span>&nbsp;Handler&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;handleMessage(Message&nbsp;msg)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">switch</span><span>&nbsp;(msg.what)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">case</span><span>&nbsp;MSG_REGISTER_CLIENT:&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allClients.add(msg.replyTo);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">case</span><span>&nbsp;MSG_UNREGISTER_CLIENT:&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allClients.remove(msg.replyTo);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">case</span><span>&nbsp;MSG_SET_VALUE:&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span><span>&nbsp;value&nbsp;=&nbsp;msg.arg1;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(</span><span class="keyword">int</span><span>&nbsp;i&nbsp;=&nbsp;</span><span class="number">0</span><span>;&nbsp;i&nbsp;&lt;&nbsp;allClients.size();&nbsp;i++)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allClients.get(i).send(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Message.obtain(<span class="keyword">null</span><span>,&nbsp;MSG_SET_VALUE,&nbsp;value,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">0</span><span>));&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(RemoteException&nbsp;e)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allClients.remove(i);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">default</span><span>:&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">super</span><span>.handleMessage(msg);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149756#" pre_index="2" title="Android Service 之三(Bind Service,使用 Messenger)" style="display: none;">// service 端的 Handler 的实现
private class IncomingHandler extends Handler {

		@Override
		public void handleMessage(Message msg) {
			switch (msg.what) {
				case MSG_REGISTER_CLIENT:
					allClients.add(msg.replyTo);
					break;
				case MSG_UNREGISTER_CLIENT:
					allClients.remove(msg.replyTo);
					break;
				case MSG_SET_VALUE:
					int value = msg.arg1;
					for (int i = 0; i &lt; allClients.size(); i++) {
						try {
							allClients.get(i).send(
									Message.obtain(null, MSG_SET_VALUE, value,
											0));
						} catch (RemoteException e) {
							allClients.remove(i);
						}
					}
					break;
				default:
					super.handleMessage(msg);
			}
		}

	}</pre>
<p>&nbsp;</p>
<div class="bar">
<div class="tools">Java代码 <a href="#" title="复制代码"><img alt="复制代码" src="/images/icon_copy.gif"></a> </div>
</div>
<div class="dp-highlighter" id=""><div class="bar"><div class="tools">Java代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%40Override%0Apublic%20IBinder%20onBind(Intent%20intent)%20%7B%0A%20%20%20%20return%20messenger.getBinder()%3B%0A%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;"><img class="star" src="/images/icon_star.png" alt="收藏代码"><img class="spinner" src="/images/spinner.gif" style="display:none"></a></div></div><ol start="1" class="dp-j"><li><span><span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">public</span><span>&nbsp;IBinder&nbsp;onBind(Intent&nbsp;intent)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;messenger.getBinder();&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div><pre class="java" name="code" codeable_id="" codeable_type="BlogComment" source_url="http://rainbow702.iteye.com/blog/1149756#" pre_index="3" title="Android Service 之三(Bind Service,使用 Messenger)" style="display: none;">@Override
public IBinder onBind(Intent intent) {
    return messenger.getBinder();
}</pre>
<p>&nbsp;</p>
<p>&nbsp;下面来看运行效果图（Debug模式）：</p>
<p>首先，启动 BindServiceDemoClient</p>
<p><br><img alt="" src="images/2e9c13a2-4801-3ba0-ac28-df4c05275dc3.jpg"><br>&nbsp;此时，所有的进程如下：</p>
<p><br><img alt="" src="images/871a213f-84f6-3d46-be62-6d4b13293d23.jpg"><br>&nbsp;最下面的那个进程即为 BindServiceDemoClient 工程对应的进程，而且还没有 BindServiceDemoService 工程的进程。下面，点击 "Bind Service" 的按钮，当执行下图中的断点时，请注意右上角 service 的类型(BindProxy)，这也从一个方面说明了为什么在 IPC 的时候不可以使用 IBinder 来实现。</p>
<p>&nbsp;<br><img height="412" alt="" class="magplus" width="700" src="images/449ff1c0-df56-38a2-af79-55b832d00c6e.jpg" title="点击查看原始大小图片"><br>按F8继续执行，会得到如下截图：</p>
<p><br><img alt="" src="images/8a179df2-c8db-3016-a2fd-666670a3ad0b.jpg"><br>&nbsp;&nbsp;</p>
<p>此时，再来看一下系统中的进程情况：</p>
<p><br><img alt="" src="images/0fd7b7b1-f364-369d-a6b0-8c4c5931201a.jpg"><br>&nbsp;会发现，在最下面多了一个 BindServiceDemoService 工程的进程，这就说明了 client 与 service 是在不同的进程内的，这也正是本例子的意图：使用 Messenger 在不同进程间进行通信。</p>
<p>&nbsp;</p>
<p>现在通过 DDMS 控制台，直接将 com.archer.rainbow.service 进程杀掉，来模拟系统资源少而急需回收系统资源的情况，如下：</p>
<p><br><img alt="" src="images/3943e115-9abb-389a-9f8a-fc4180305750.jpg"><br>&nbsp;系统会输出如下日志：</p>
<p><br><img height="20" alt="" class="magplus" width="700" src="images/4b1208b5-61b3-3bc9-aa63-13a5b6e7e0c0.jpg" title="点击查看原始大小图片"><br>&nbsp;之后，当系统资源充足的时候，会自己重新启动该进程，如下图：</p>
<p><br><img alt="" src="images/4fdea833-c3de-3642-b99e-c2763b13e42b.jpg"><br>&nbsp;同时，系统输出的日志为：</p>
<p><br><img height="10" alt="" class="magplus" width="700" src="images/a491fcbc-1d3f-3e55-8c8c-b24be594b4d1.jpg" title="点击查看原始大小图片"></p>
<p>另外，需要注意的是，当我们通过界面点击 "Unbind Service" 的时候，虽然服务被解绑了，但是系统并没有立即将 com.archer.rainbow.service 这一进程给杀掉：</p>
<p>&nbsp;<br><img alt="" src="images/ee851f99-c495-3095-affb-0c3734ea7b20.jpg"><br>&nbsp;<br><img alt="" src="images/241eac71-75b1-31e8-aad2-937c5f6d0c0f.jpg"><br>&nbsp;但若此时，通过 DDMS 控制台，直接将该进程杀掉的话，系统也不会重新启动该进程</p>
<p><br><img alt="" src="images/61d49a2b-4f47-375a-bad5-23f4b496ae80.jpg"><br>&nbsp;</p>
<p><br><img height="12" alt="" class="magplus" width="700" src="images/a8062a4a-9d7d-368c-acd4-ef9170f3bdf4.jpg" title="点击查看原始大小图片"><br>&nbsp;注意与上面对应的日志进行比对，你会发现它少了 "Scheduling restart........" 的这条日志。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;">PS：若想将 service 在另一个进程中启动，你也可以在声明 Service 的时候，使用 "android:process=":remote"" 这种方式来实现。</span></p>
  </div>